<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>types.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>types.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>... is a submodule of <a href="__init__.html">blob_types</a>.
It contains abstract classes which help to build serializable data structures.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">flat_struct</span><span class="p">,</span> <span class="n">camel_case_to_underscore</span><span class="p">,</span> <span class="n">underscore_to_camel_case</span><span class="p">,</span> <span class="n">get_blob_index</span><span class="p">,</span> <span class="n">diff_dtype</span><span class="p">,</span> <span class="n">vector_fields</span><span class="p">,</span> <span class="n">implode_float_n</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">validate_dtype_params</span><span class="p">(</span><span class="n">function</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dtype_params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cls</span><span class="o">.</span><span class="n">is_plain</span><span class="p">():</span>
            <span class="n">dtype_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s">&#39;expect dtype_params as dict instead of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="n">expected_keys</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>validate dtype_params</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> requires argument </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">process_dtype_params</span><span class="p">(</span><span class="n">function</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dtype_params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cls</span><span class="o">.</span><span class="n">is_plain</span><span class="p">():</span>
            <span class="n">dtype_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dtype_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> requires argument dtype or dtype_params not </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>validate dtype_params</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> requires argument </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;create_dtype&#39;</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;invalid value of </span><span class="si">%s</span><span class="s"> (</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BlobArray</span><span class="p">):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">function</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;create_dtype&#39;</span><span class="p">,</span> <span class="s">&#39;create_dtype requires dtype_params, maybe the parameters are now named&#39;</span>

        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BlobValidationException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">EnumException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Encapsulates an binary space as python object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Blob</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>A Blob is an abstract class, whose objects encapsulate and numpy.ndarray with a defined type structure.
The type structure is based on numpy.dtypes and nested structures. 
It manages the access to variables which are stored in the space of binary memory (blob).
It generates c99 struct declarations.</p>
<p>Subclasses can override the following class attributes: </p>
<pre><code>cname       # the name of the c99 structure
dtype       # the type definition
subtypes    # the class definition of nested Blob-types
</code></pre>
<p>todo: use <strong>metaclass</strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">MAX_DTYPE_PARAM</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">PADDING_FIELD_SUFFIX</span> <span class="o">=</span> <span class="s">&#39;__padding&#39;</span>

    <span class="n">_dtypes</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># map of known types for reuse and save memory</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Returns all required Blob-types (without transitions).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_complex</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BlobArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">BlobEnum</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_plain</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BlobArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">subtype</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">subtype</span><span class="o">.</span><span class="n">is_plain</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">subtype</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                <span class="n">requirements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtype</span><span class="o">.</span><span class="n">get_requirements</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">,</span> <span class="n">subtypes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)</span>
            <span class="n">requirements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtypes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">requirements</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dtype_param_keys</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BlobArray</span><span class="p">):</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BlobArray</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">)</span>
            <span class="n">subparams</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">subparams</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subparams</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subtype</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">():</span>
                        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c"># Blob without Blob fields</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c"># Blob without Blob fields</span>

        <span class="k">return</span> <span class="n">keys</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dummy_dtype_params</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">dtype_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">():</span>
            <span class="n">dtype_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">dtype_params</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@process_dtype_params</span>
    <span class="k">def</span> <span class="nf">create_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">subtypes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">dtype_params_keys</span> <span class="o">=</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">dtype_params_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">hashable_dtype_params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dtype_params_keys</span><span class="p">:</span>
            <span class="n">hashable_dtype_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">hashable_dtype_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">hashable_dtype_params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">hashable_dtype_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hashable_dtype_params</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">hashable_dtype_params</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="n">subtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">explode_dtype_params</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                <span class="n">subtypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">subtype</span><span class="o">.</span><span class="n">create_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">subtype_params</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">subtypes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">subtype</span><span class="p">))</span>

        <span class="n">dtype</span><span class="p">,</span> <span class="n">subtypes_</span> <span class="o">=</span> <span class="n">Blob</span><span class="o">.</span><span class="n">create_plain_dtype</span><span class="p">(</span><span class="o">*</span><span class="n">subtypes</span><span class="p">)</span>

        <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">hashable_dtype_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="k">return</span> <span class="n">dtype</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@process_dtype_params</span>
    <span class="k">def</span> <span class="nf">allocate_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">unshape</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">init_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">blob</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_subtypes_params</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">subtype_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BlobArray</span><span class="p">):</span>
            <span class="n">subtype_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">get_subtypes_params</span><span class="p">())</span>
            <span class="n">subtype_params</span><span class="p">[</span><span class="n">BlobArray</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">]</span> <span class="o">=</span> <span class="n">BlobArray</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                    <span class="n">subtype_params</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">get_subtypes_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">flat_struct</span><span class="p">(</span><span class="n">subtype_params</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">explode_dtype_params</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span>
        <span class="n">field_prefix</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_&#39;</span> <span class="o">%</span> <span class="n">field</span>

        <span class="n">subtypes_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_subtypes_params</span><span class="p">()</span>
        <span class="n">subtype_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">subtypes_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="n">subtype_param_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">field_prefix</span><span class="p">):]</span>

                <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="s">&#39;assert </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s"> for subtype of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">dtype_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> should be an integer instead of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                <span class="n">subtype_params</span><span class="p">[</span><span class="n">subtype_param_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">subtype_params</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">sizeof_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="n">subtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">explode_dtype_params</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                <span class="n">subtype_size</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">sizeof_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">subtype_params</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issctype</span><span class="p">(</span><span class="n">subtype</span><span class="p">):</span>
                <span class="n">subtype_size</span> <span class="o">=</span> <span class="n">subtype</span><span class="p">()</span><span class="o">.</span><span class="n">nbytes</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

            <span class="n">size</span> <span class="o">+=</span> <span class="n">subtype_size</span>

        <span class="k">return</span> <span class="n">size</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">explode_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blobs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subtype_field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>

                <span class="n">subtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">explode_dtype_params</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">subtype_field</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="n">subtype_params</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">subtype_params</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                    <span class="n">subtype_dtype</span><span class="p">,</span> <span class="n">subtype_blob</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">cast_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">subtype_params</span><span class="p">)</span>
                    <span class="n">subtype_byte_count</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">sizeof_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">subtype_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subtype_blob</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">subtype_byte_count</span> <span class="o">=</span> <span class="n">subtype</span><span class="p">()</span><span class="o">.</span><span class="n">itemsize</span>

                <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">subtype_field</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">subtype_blob</span>

                <span class="n">blobs</span><span class="p">[</span><span class="n">subtype_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtype_blob</span>

                <span class="n">offset</span> <span class="o">+=</span> <span class="n">subtype_byte_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">blobs</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">init_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">):</span>
            <span class="n">blobs</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">explode_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">blobs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> has an invalid explode_blob implementation &#39;</span> <span class="o">%</span> <span class="n">cls</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">blobs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> has an invalid explode_blob implementation &#39;</span> <span class="o">%</span> <span class="n">cls</span>

            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">):</span>
                    <span class="n">subtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">explode_dtype_params</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
                    <span class="n">subtype</span><span class="o">.</span><span class="n">init_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blobs</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">subtype_params</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@process_dtype_params</span>
    <span class="k">def</span> <span class="nf">cast_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">casted_blob_</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">casted_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">unshape</span><span class="p">(</span><span class="n">casted_blob_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">casted_blob</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;failed to cast </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cls</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">unshape</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
            <span class="k">return</span> <span class="n">blob</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blob</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_subtypes</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Result is a tuple of two lists, with the attribute names and with the types.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_plain_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">subtypes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">implode_float_n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_create_aligned_dtype</span><span class="p">(</span><span class="o">*</span><span class="n">subtypes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_create_unaligned_dtype</span><span class="p">(</span><span class="o">*</span><span class="n">subtypes</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_unaligned_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">subtypes</span><span class="p">):</span>

        <span class="n">dtype_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subtypes</span><span class="p">):</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="o">=</span> <span class="n">component</span>

            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issctype</span><span class="p">(</span><span class="n">subtype</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="s">&#39;descr&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sub_dtype</span> <span class="ow">in</span> <span class="n">subtype</span><span class="o">.</span><span class="n">descr</span><span class="p">:</span>
                        <span class="n">subfield</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subfield</span><span class="p">,</span> <span class="n">sub_dtype</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">BlobEnum</span><span class="p">):</span>
                <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">BlobEnum</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">Blob</span><span class="p">)</span> <span class="ow">and</span> <span class="n">subtype</span><span class="o">.</span><span class="n">is_plain</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">):</span>
                    <span class="n">sub_dtype</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">dtype</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_dtype</span><span class="p">,</span> <span class="n">subtype_requirements</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">create_plain_dtype</span><span class="p">(</span><span class="o">*</span><span class="n">subtype</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sub_dtype</span> <span class="ow">in</span> <span class="n">sub_dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">:</span>
                    <span class="n">subfield</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subfield</span><span class="p">,</span> <span class="n">sub_dtype</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_components</span><span class="p">),</span> <span class="n">subtypes</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_aligned_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">subtypes</span><span class="p">):</span>

        <span class="n">dtype_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subtypes</span><span class="p">):</span>
            <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>  <span class="c">#todo: add components of subfields of type blob</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="o">=</span> <span class="n">component</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>determine padding attributes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">is_last_of_vector</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vector_index</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">vector_field</span> <span class="ow">in</span> <span class="n">vector_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">vector_field</span><span class="p">:</span>
                    <span class="n">vector_index</span> <span class="o">=</span> <span class="n">vector_field</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">vector_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector_field</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">is_last_of_vector</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtypes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">subtypes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">vector_field</span><span class="p">[</span><span class="n">vector_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                        <span class="n">is_last_of_vector</span> <span class="o">=</span> <span class="bp">False</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">is_last_of_vector</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>add padding</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">is_last_of_vector</span> <span class="ow">and</span> <span class="n">vector_index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">PADDING_FIELD_SUFFIX</span><span class="p">),</span> <span class="n">subtype</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_components</span><span class="p">),</span> <span class="n">subtypes</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Creates and initializes a object from a struct.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_struct</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(),</span> <span class="s">&#39;the blob must be plain&#39;</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_init_blob_from_struct&#39;</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> requires an implementation of _init_blob_from_struct&#39;</span> <span class="o">%</span> <span class="n">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_blob_from_struct</span><span class="p">(</span><span class="n">struct</span><span class="o">=</span><span class="n">flat_struct</span><span class="p">(</span><span class="n">struct</span><span class="p">),</span> <span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Space of binary memory (numpy.ndarray).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_field_by_param_key</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">parent_field</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="n">parent_field_</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_field_</span><span class="p">):</span>
                <span class="n">subkey</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">get_field_by_param_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">parent_field_</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">subkey</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>

        <span class="n">dtype_param_keys</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">()</span>
        <span class="n">dtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dummy_dtype_params</span><span class="p">()</span>
        <span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dtype_param_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done_keys</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                    <span class="n">done_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                    <span class="n">dummy_dtype</span><span class="p">,</span> <span class="n">dummy_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">cast_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
                    <span class="n">key_field</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">get_field_by_param_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">get_blob_index</span><span class="p">(</span><span class="n">dummy_dtype</span><span class="p">,</span> <span class="n">key_field</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;dtype has no field </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key_field</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">dummy_blob</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">cls</span><span class="o">.</span><span class="n">MAX_DTYPE_PARAM</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BlobValidationException</span><span class="p">(</span>
                            <span class="s">&#39;dtype param </span><span class="si">%s</span><span class="s"> must be smaller than </span><span class="si">%d</span><span class="s"> (</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">MAX_DTYPE_PARAM</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">BlobValidationException</span><span class="p">(</span>
                            <span class="s">&#39;dtype param </span><span class="si">%s</span><span class="s"> must be positive (</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

                    <span class="n">dtype_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">assert</span> <span class="n">dtype_param_keys</span> <span class="o">==</span> <span class="n">done_keys</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dtype_param_keys</span><span class="p">,</span> <span class="n">done_keys</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dtype_params</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>

        <span class="n">dtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">]:</span> <span class="c"># is void</span>
            <span class="n">dtype</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">cast_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">diff_dtype</span><span class="p">(</span><span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Initializes the object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blob</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">allocate_blob</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">dtype_is_static</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="n">dtype_is_static</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">assert</span> <span class="n">dtype_params</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">dtype_is_static</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: a dtype or the factory parameter must be set.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>determine dtype by creation parameters if dtype is unset</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtype_is_static</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>determine blob properties</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">blob_properties</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">blob_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">blob_properties</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;a Blob must encapsulate more than one variable: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">blob_properties</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>init object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_field_offsets</span> <span class="o">=</span> <span class="n">blob_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="o">=</span> <span class="n">blob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>init subtypes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;subtypes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">blobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explode_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subtype_field</span><span class="p">,</span> <span class="n">subtype_blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">subtype_field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">subtype_field</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtype_field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">name_</span><span class="p">,</span> <span class="n">type_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtypes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">subtype_field</span> <span class="o">==</span> <span class="n">name_</span><span class="p">:</span>
                        <span class="n">subtype_cls</span> <span class="o">=</span> <span class="n">type_</span>

                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype_cls</span><span class="p">,</span> <span class="n">Blob</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">subtype_cls</span><span class="p">,</span> <span class="n">BlobEnum</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">subtype_cls</span><span class="o">.</span><span class="n">from_blob</span><span class="p">(</span><span class="n">subtype_blob</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtype_field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>init plain fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">diff_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Copy all elements of a struct into the blob.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_init_blob_from_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">struct</span> <span class="o">=</span> <span class="n">flat_struct</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>copy elements </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">camel_case_to_underscore</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">,</span> <span class="s">&#39;unknown key </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>assert that all elements are initialized</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_name</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name_</span><span class="p">:</span> <span class="p">(</span><span class="n">name_</span><span class="p">,</span> <span class="n">underscore_to_camel_case</span><span class="p">(</span><span class="n">name_</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">struct</span> <span class="ow">or</span> <span class="n">_name</span> <span class="ow">in</span> <span class="n">struct</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">PADDING_FIELD_SUFFIX</span><span class="p">),</span>  <span class="s">&#39;uninitialized key </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Get a function that casts the blob element to the correct python type.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_data_property_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">property_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">byte_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_field_offsets</span><span class="p">[</span><span class="n">property_index</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">cast_bool</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;&lt;f4&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="s">&#39;&lt;i4&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s">&#39;|i1&#39;</span><span class="p">:</span> <span class="n">cast_bool</span>
        <span class="p">}[</span><span class="n">byte_offset</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Set the attribute 'name'.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Try to save it in the blob first, then try to save it in the python object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;_blob_fields_&#39;</span><span class="p">,</span> <span class="s">&#39;_blob_field_offsets&#39;</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">]</span> \
            <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Compares the representation of each field and return false, if one differs.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>repr is used to support NAN values.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">field</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__diff__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">field</span><span class="p">)):</span>
                <span class="k">return</span> <span class="s">&#39;self.</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">: other.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Get the value of the attribute 'name'.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Try to get it from the blob first, then try to get it from the python object.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;_blob_fields_&#39;</span><span class="p">,</span> <span class="s">&#39;_blob_field_offsets&#39;</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_blob_fields_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">cast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_property_type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Generates a struct from the blob data.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>todo: unflat the structure</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">struct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob_fields_</span><span class="p">:</span>
            <span class="n">struct</span><span class="p">[</span><span class="n">underscore_to_camel_case</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Encapsulates an array of Blob.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BlobArray</span><span class="p">(</span><span class="n">Blob</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>A BlobArray is an abstract class that encapsulates an array of Blob objects.
The number of elements must be known when the object is created.
It generates a (dummy) c99 struct declaration as well as a deserializer function, which returns a reference to the array.</p>
<p>The subclass can override the following class attributes:</p>
<pre><code>cname          # the name of the c99 structure
</code></pre>
<p>It must implement the following:</p>
<pre><code>child_type     # the Blob-type of the array elements
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">child_type</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># must be overridden by specialized class</span>

    <span class="n">STATIC_FIELDS_BYTES</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">CAPACITY_FIELD</span> <span class="o">=</span> <span class="s">&#39;capacity&#39;</span>
    <span class="n">COUNT_FIELD_NAME</span> <span class="o">=</span> <span class="s">&#39;count&#39;</span>
    <span class="n">INDEX_FIELD</span> <span class="o">=</span> <span class="s">&#39;global_index&#39;</span>
    <span class="n">dtype_static_components</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">CAPACITY_FIELD</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="n">COUNT_FIELD_NAME</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">_dtypes</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># map of known types for reuse and save memory</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Creates the dtype based on the number of items.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_item_field</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;item_</span><span class="si">%d</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@process_dtype_params</span>
    <span class="k">def</span> <span class="nf">create_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_child_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="n">dtype_params_keys</span> <span class="o">=</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">dtype_params_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">hashable_dtype_params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dtype_params_keys</span><span class="p">:</span>
            <span class="n">hashable_dtype_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">hashable_dtype_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">hashable_dtype_params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">hashable_dtype_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hashable_dtype_params</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">hashable_dtype_params</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;global_index&#39;</span><span class="p">,</span> <span class="s">&#39;child_type of </span><span class="si">%s</span><span class="s"> has no global_index field&#39;</span> <span class="o">%</span> <span class="n">cls</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="s">&#39;expected int instead of </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">capacity</span><span class="p">),</span> <span class="n">capacity</span><span class="p">)</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">capacity</span><span class="p">)</span>

        <span class="n">dtype_components</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">dtype_static_components</span><span class="p">[:]</span>

        <span class="k">assert</span> <span class="n">capacity</span> <span class="o">&lt;</span> <span class="mi">1000000</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">capacity</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">:</span>
                <span class="n">dtype_components</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cls</span><span class="o">.</span><span class="n">get_item_field</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">dtype</span><span class="p">))</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_components</span><span class="p">)</span>

        <span class="n">cls</span><span class="o">.</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">hashable_dtype_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="k">return</span> <span class="n">dtype</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Returns all direct required Blob-types.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_subtypes</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>Returns all recursive required Blob-types.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">requirements</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">get_requirements</span><span class="p">()</span>
        <span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">requirements</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Calculates the memory space, which the object requires.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">create_child_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span>
        <span class="n">dtype_params</span> <span class="o">=</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">dtype_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;child_type&#39;</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">),</span> <span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="p">,</span> <span class="s">&#39;dtype&#39;</span><span class="p">):</span>
            <span class="n">child_dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">child_dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">create_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@validate_dtype_params</span>
    <span class="k">def</span> <span class="nf">sizeof_dtype</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_child_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="n">metadata_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">dtype_static_components</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">content_size</span> <span class="o">=</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">capacity</span>

        <span class="k">return</span> <span class="n">metadata_size</span> <span class="o">+</span> <span class="n">content_size</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="nd">@process_dtype_params</span>
    <span class="k">def</span> <span class="nf">init_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">diff_dtype</span><span class="p">(</span><span class="n">blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

        <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_child_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>set initial values</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">blob</span><span class="p">[</span><span class="n">get_blob_index</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">)]</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="n">blob</span><span class="p">[</span><span class="n">get_blob_index</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">COUNT_FIELD_NAME</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">capacity</span><span class="p">):</span>
            <span class="n">item_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_item_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="n">child_dtype</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">init_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">item_blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>
            <span class="n">item_blob</span><span class="p">[</span><span class="n">get_blob_index</span><span class="p">(</span><span class="n">child_dtype</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">INDEX_FIELD</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Returns a blob of the element with an index.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_item_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(),</span> <span class="s">&#39;exptected blob shape </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s">&#39;the index must be in integer&#39;</span>

        <span class="k">if</span> <span class="n">child_dtype</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">get_dtype_param_keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">child_dtype</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">dtype</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>get offset</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">offset</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">STATIC_FIELDS_BYTES</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">index</span>

        <span class="k">assert</span> <span class="n">cls</span><span class="o">.</span><span class="n">STATIC_FIELDS_BYTES</span> <span class="o">+</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="n">blob</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">blob</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> \
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">: dtype:</span><span class="si">%d</span><span class="s"> + </span><span class="si">%d</span><span class="s"> * </span><span class="si">%d</span><span class="s"> + </span><span class="si">%d</span><span class="s"> = </span><span class="si">%d</span><span class="s"> &lt;= blob:</span><span class="si">%d</span><span class="s"> * </span><span class="si">%d</span><span class="s"> = </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">),</span>
                <span class="n">cls</span><span class="o">.</span><span class="n">STATIC_FIELDS_BYTES</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>
                <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">STATIC_FIELDS_BYTES</span> <span class="o">+</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="n">child_dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">),</span>
                <span class="n">blob</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">blob</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>
                <span class="n">blob</span><span class="o">.</span><span class="n">nbytes</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>get blob</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">item_blob</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">getfield</span><span class="p">(</span><span class="n">child_dtype</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>validate blob</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">assert</span> <span class="n">item_blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(),</span> <span class="s">&#39;blob must be a flat struct instead of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">item_blob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>return blob</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">item_blob</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Creates and initializes a object from a struct.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>

        <span class="n">dtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">)</span>
        <span class="n">dtype</span><span class="p">,</span> <span class="n">casted_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">cast_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">casted_blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">])</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_struct</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(),</span> <span class="s">&#39;the blob must be plain&#39;</span>

        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">child_struct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">struct</span><span class="p">):</span>
            <span class="n">child_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_item_blob</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">from_struct</span><span class="p">(</span><span class="n">struct</span><span class="o">=</span><span class="n">child_struct</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">child_blob</span><span class="p">))</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_field_by_param_key</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">parent_field</span><span class="p">):</span>
        <span class="n">key_</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">key_</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="n">key_</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_field</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span><span class="p">):]</span>

        <span class="n">key_</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_item_field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key_</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">key_</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_capacity</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>

        <span class="nb">isinstance</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s">&#39;dtype_params must contain the integer field capacity&#39;</span>

        <span class="k">if</span> <span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BlobValidationException</span><span class="p">(</span><span class="s">&#39;array capacity must be positive instead of </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">capacity</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="n">Blob</span><span class="o">.</span><span class="n">MAX_DTYPE_PARAM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BlobValidationException</span><span class="p">(</span><span class="s">&#39;array capacity must smaller than 1000 instead of </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">capacity</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>create dummy</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">dtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_dummy_dtype_params</span><span class="p">()</span>
        <span class="n">dummy_dtype</span><span class="p">,</span> <span class="n">dummy_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">cast_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>determine capacity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">field_index</span> <span class="o">=</span> <span class="n">get_blob_index</span><span class="p">(</span><span class="n">dummy_dtype</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">)</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">dummy_blob</span><span class="p">[</span><span class="n">field_index</span><span class="p">]</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">validate_capacity</span><span class="p">(</span><span class="n">capacity</span><span class="p">)</span>
        <span class="n">dtype_params</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">]</span> <span class="o">=</span> <span class="n">capacity</span>

        <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_child_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">)</span>
        <span class="n">item_blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_item_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">dummy_blob</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="n">child_dtype</span><span class="p">)</span>
        <span class="n">child_dtype_params</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">get_dtype_params_from_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">item_blob</span><span class="p">)</span>

        <span class="n">dtype_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">child_dtype_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dtype_params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blob</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">allocate_blob</span><span class="p">(</span><span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="p">:</span> <span class="c">#todo: remove this later</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">capacity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">capacity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: an empty list? use java for that!&#39;</span> <span class="o">%</span> <span class="n">cls</span>
        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="k">assert</span> <span class="n">blob</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: the blob must be greater than the index variable space&#39;</span> <span class="o">%</span> <span class="n">cls</span>

        <span class="k">assert</span> <span class="n">dtype_params</span> <span class="ow">or</span> <span class="n">dtype</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: a dtype or the factory parameter must be set.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dtype_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">:</span> <span class="n">capacity</span><span class="p">}</span>  <span class="c">#todo: maybe this is not enough</span>

        <span class="k">assert</span> <span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span> <span class="ow">in</span> <span class="n">dtype_params</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">validate_capacity</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">CAPACITY_FIELD</span><span class="p">])</span>

        <span class="n">Blob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">dtype_params</span><span class="o">=</span><span class="n">dtype_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">items</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">!=</span> <span class="n">capacity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>

        <span class="n">valid_item_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_item_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">break</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">child_dtype</span><span class="p">,</span> <span class="n">capacity_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_child_dtype</span><span class="p">(</span><span class="n">dtype_params</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">):</span>
                <span class="n">item_blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="n">child_dtype</span><span class="p">)</span>
                <span class="n">index_</span> <span class="o">=</span> <span class="n">item_blob</span><span class="p">[</span><span class="n">get_blob_index</span><span class="p">(</span><span class="n">item_blob</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s">&#39;global_index&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">index_</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">from_blob</span><span class="p">(</span><span class="n">item_blob</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">raise</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Returns the element at the given index.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Returns an iterator over the stored elements.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>Returns the number of stored elements.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>Returns a struct representation of all stored elements.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_struct</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BlobLinkedList</span><span class="p">(</span><span class="n">BlobArray</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">next_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="s">&#39;not enough capacity </span><span class="si">%d</span><span class="s"> &lt; </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>

        <span class="n">item_blob</span> <span class="o">=</span> <span class="n">BlobArray</span><span class="o">.</span><span class="n">get_item_blob</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blob</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">child_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">global_index_field_index</span> <span class="o">=</span> <span class="n">get_blob_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_type</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s">&#39;global_index&#39;</span><span class="p">)</span>
        <span class="n">item_blob</span><span class="p">[</span><span class="n">global_index_field_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">return</span> <span class="n">item_blob</span><span class="p">,</span> <span class="n">index</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">global_index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">global_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">global_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">BlobEnum</span><span class="p">(</span><span class="n">Blob</span><span class="p">):</span>

    <span class="n">dtype</span><span class="p">,</span> <span class="n">subtypes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[]</span>

    <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="s">&#39;undefined&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">string_to_int</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">int_to_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">UNDEFINED</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EnumException</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> is out of range&#39;</span> <span class="o">%</span> <span class="n">index</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EnumException</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
